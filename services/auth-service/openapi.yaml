openapi: 3.1.0
info:
  title: Authentication Service API
  version: 1.0.0
  description: |
    OAuth2/OIDC Authentication Service API for the SOA ecosystem.
    Handles token exchange, validation, user information retrieval, and session management.
  contact:
    name: API Support
    email: support@auth.example.com
  license:
    name: MIT
    url: https://opensource.org/licenses/MIT

servers:
  - url: https://api.example.com/auth
    description: Production server
  - url: https://staging-api.example.com/auth
    description: Staging server
  - url: http://localhost:3001/auth
    description: Local development

tags:
  - name: Authentication
    description: OAuth2/OIDC authentication operations
  - name: Tokens
    description: Token management and validation
  - name: User Info
    description: Authenticated user information

paths:
  /auth/token:
    post:
      tags:
        - Authentication
      summary: Exchange authorization code for tokens
      description: |
        Exchanges an authorization code for access and refresh tokens.
        Supports both authorization_code and refresh_token grant types.
      operationId: exchangeToken
      requestBody:
        required: true
        content:
          application/json:
            schema:
              oneOf:
                - $ref: '#/components/schemas/AuthorizationCodeRequest'
                - $ref: '#/components/schemas/RefreshTokenRequest'
            examples:
              authorizationCode:
                summary: Authorization code exchange
                value:
                  grant_type: "authorization_code"
                  code: "auth-code-xyz"
                  state: "state-abc"
              refreshToken:
                summary: Refresh token exchange
                value:
                  grant_type: "refresh_token"
                  refresh_token: "refresh-token-xyz"
      responses:
        '200':
          description: Tokens issued successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TokenResponse'
              example:
                access_token: "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."
                token_type: "Bearer"
                expires_in: 3600
                refresh_token: "refresh-token-xyz"
                scope: "openid profile email"
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /auth/userinfo:
    get:
      tags:
        - User Info
      summary: Get authenticated user information
      description: |
        Returns information about the authenticated user.
        Requires a valid Bearer token in the Authorization header.
      operationId: getUserInfo
      security:
        - bearerAuth: []
      responses:
        '200':
          description: User information retrieved successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UserInfo'
              example:
                sub: "user-12345"
                email: "user@example.com"
                email_verified: true
                name: "John Doe"
                roles:
                  - "role-student"
                permissions:
                  - "read:calendar"
                  - "write:reminders"
                iat: 1699712400
                exp: 1699716000
        '401':
          $ref: '#/components/responses/Unauthorized'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /auth/validate:
    post:
      tags:
        - Tokens
      summary: Validate a JWT token
      description: |
        Validates a JWT token and returns the payload if valid.
        Does not require the token to be in the Authorization header.
      operationId: validateToken
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                token:
                  type: string
                  description: JWT token to validate
              required:
                - token
            example:
              token: "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."
      responses:
        '200':
          description: Token validation result
          content:
            application/json:
              schema:
                type: object
                properties:
                  valid:
                    type: boolean
                    description: Whether the token is valid
                  payload:
                    type: object
                    description: Token payload if valid, null otherwise
                    nullable: true
                  error:
                    type: string
                    description: Error message if invalid, null otherwise
                    nullable: true
              example:
                valid: true
                payload:
                  sub: "user-12345"
                  email: "user@example.com"
                  iat: 1699712400
                  exp: 1699716000
                error: null
        '400':
          $ref: '#/components/responses/BadRequest'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /auth/logout:
    post:
      tags:
        - Authentication
      summary: Logout and invalidate session
      description: |
        Logs out the user and revokes their tokens.
        Requires a valid Bearer token in the Authorization header.
      operationId: logout
      security:
        - bearerAuth: []
      responses:
        '204':
          description: User logged out successfully
        '401':
          $ref: '#/components/responses/Unauthorized'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /health:
    get:
      tags:
        - Health
      summary: Health check endpoint
      description: Returns the health status of the auth service
      operationId: healthCheck
      responses:
        '200':
          description: Service is healthy
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    example: "healthy"
                  service:
                    type: string
                    example: "Auth Service"
                  timestamp:
                    type: string
                    format: date-time
                  uptime:
                    type: number
                    example: 123.456
                  environment:
                    type: string
                    example: "development"

components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
      description: JWT access token from /auth/token endpoint

  schemas:
    AuthorizationCodeRequest:
      type: object
      properties:
        grant_type:
          type: string
          enum: [authorization_code]
        code:
          type: string
          description: Authorization code from OIDC provider
        state:
          type: string
          description: Optional state parameter for CSRF protection
      required:
        - grant_type
        - code

    RefreshTokenRequest:
      type: object
      properties:
        grant_type:
          type: string
          enum: [refresh_token]
        refresh_token:
          type: string
          description: Refresh token from previous token response
      required:
        - grant_type
        - refresh_token

    TokenResponse:
      type: object
      properties:
        access_token:
          type: string
          description: JWT access token
        token_type:
          type: string
          enum: [Bearer]
          description: Token type
        expires_in:
          type: integer
          description: Token expiration time in seconds
        refresh_token:
          type: string
          description: Refresh token for obtaining new access tokens
        scope:
          type: string
          description: Granted scopes

    UserInfo:
      type: object
      properties:
        sub:
          type: string
          description: Subject (user ID)
        email:
          type: string
          format: email
          description: User's email address
        email_verified:
          type: boolean
          description: Whether the email is verified
        name:
          type: string
          description: User's full name
        roles:
          type: array
          items:
            type: string
          description: User's assigned roles
        permissions:
          type: array
          items:
            type: string
          description: User's permissions
        iat:
          type: integer
          description: Token issued at (Unix timestamp)
        exp:
          type: integer
          description: Token expiration (Unix timestamp)

    ErrorResponse:
      type: object
      properties:
        error:
          type: string
          description: Error code
        error_description:
          type: string
          description: Human-readable error description
        status_code:
          type: integer
          description: HTTP status code
        timestamp:
          type: string
          format: date-time
          description: When the error occurred
      required:
        - error
        - error_description
        - status_code

  responses:
    BadRequest:
      description: Bad request - invalid parameters
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
          example:
            error: "invalid_request"
            error_description: "grant_type parameter is required"
            status_code: 400
            timestamp: "2025-11-11T16:30:00Z"

    Unauthorized:
      description: Unauthorized - missing or invalid credentials
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
          example:
            error: "invalid_token"
            error_description: "Authorization header with Bearer token is required"
            status_code: 401
            timestamp: "2025-11-11T16:30:00Z"

    Forbidden:
      description: Forbidden - user lacks required permissions
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
          example:
            error: "insufficient_permissions"
            error_description: "User lacks required permissions"
            status_code: 403
            timestamp: "2025-11-11T16:30:00Z"

    InternalServerError:
      description: Internal server error
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
          example:
            error: "server_error"
            error_description: "An unexpected error occurred"
            status_code: 500
            timestamp: "2025-11-11T16:30:00Z"
